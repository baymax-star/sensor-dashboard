<?php
// Supabase configuration
$supabaseUrl = 'https://aydpmoleewyaukeghnrr.supabase.co';
$supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF5ZHBtb2xlZXd5YXVrZWdobnJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5ODY4MjAsImV4cCI6MjA2NjU2MjgyMH0.WDQD0L1bwjwQilmy_7j0U0mBHCA7SQXE47lZYiIHRpk';

// Debug flag
$debug = true;

// Function to make Supabase API requests
function supabaseQuery($endpoint, $method = 'GET', $data = null) {
    global $supabaseUrl, $supabaseKey, $debug;
    
    $url = $supabaseUrl . '/rest/v1/' . $endpoint;
    $headers = [
        'apikey: ' . $supabaseKey,
        'Authorization: Bearer ' . $supabaseKey,
        'Content-Type: application/json',
        'Prefer: return=representation'
    ];
    
    if ($debug) {
        echo "<!-- DEBUG: Requesting URL: $url -->\n";
    }
    
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_TIMEOUT, 30);
    
    if ($data && $method !== 'GET') {
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    }
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    curl_close($ch);
    
    if ($debug) {
        echo "<!-- DEBUG: HTTP Code: $httpCode -->\n";
        echo "<!-- DEBUG: Response: " . substr($response, 0, 500) . " -->\n";
        if ($error) {
            echo "<!-- DEBUG: CURL Error: $error -->\n";
        }
    }
    
    if ($error) {
        error_log("CURL Error: " . $error);
        return false;
    }
    
    if ($httpCode >= 200 && $httpCode < 300) {
        $decoded = json_decode($response, true);
        if (json_last_error() !== JSON_ERROR_NONE) {
            error_log("JSON Decode Error: " . json_last_error_msg());
            return false;
        }
        return $decoded;
    } else {
        error_log("Supabase API Error (HTTP $httpCode): " . $response);
        return false;
    }
}

// Get latest sensor data for each device (equivalent to your original query)
$latestDataEndpoint = 'sensor_data_complete?select=*&order=received_at.desc&limit=100';
$allData = supabaseQuery($latestDataEndpoint);

if ($debug && $allData === false) {
    echo "<!-- DEBUG: Failed to fetch data from Supabase -->\n";
}

// Process data to get latest for each device
$latestByDevice = [];
if ($allData && is_array($allData)) {
    if ($debug) {
        echo "<!-- DEBUG: Retrieved " . count($allData) . " records -->\n";
    }
    
    foreach ($allData as $row) {
        $deviceId = $row['device_id'];
        if (!isset($latestByDevice[$deviceId]) || 
            strtotime($row['received_at']) > strtotime($latestByDevice[$deviceId]['received_at'])) {
            $latestByDevice[$deviceId] = $row;
        }
    }
    
    if ($debug) {
        echo "<!-- DEBUG: Found " . count($latestByDevice) . " unique devices -->\n";
        echo "<!-- DEBUG: Device IDs: " . implode(', ', array_keys($latestByDevice)) . " -->\n";
    }
} else {
    if ($debug) {
        echo "<!-- DEBUG: No data returned or invalid format -->\n";
    }
}

// Get all historical data (limit to prevent timeout)
$historyData = supabaseQuery('sensor_data_complete?select=*&order=received_at.desc&limit=500');

// Get unique device IDs for filter
$uniqueDevices = [];
if ($historyData && is_array($historyData)) {
    foreach ($historyData as $row) {
        if (!in_array($row['device_id'], $uniqueDevices)) {
            $uniqueDevices[] = $row['device_id'];
        }
    }
    sort($uniqueDevices);
    
    if ($debug) {
        echo "<!-- DEBUG: History data count: " . count($historyData) . " -->\n";
        echo "<!-- DEBUG: Unique devices from history: " . implode(', ', $uniqueDevices) . " -->\n";
    }
}
?>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Sensor - Supabase</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        /* Main Dashboard Grid - 4 nodes in one row */
        .main-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .node-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .node-header {
            background-color: #34495e;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .node-header h2 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .node-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #27ae60;
        }
        .status-indicator.offline {
            background-color: #e74c3c;
        }
        
        .node-content {
            padding: 15px;
        }
        
        /* Sensor Grid - 2x2 layout for each node */
        .sensor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .sensor-item {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .sensor-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .sensor-value {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .sensor-unit {
            font-size: 0.7rem;
            color: #6c757d;
        }
        
        .status-item {
            grid-column: 1 / -1;
            background-color: #f1f3f4;
        }
        
        .status-main {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .status-details {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .aqi-info {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #dee2e6;
        }
        
        .aqi-label {
            font-size: 0.7rem;
            color: #6c757d;
            margin-bottom: 3px;
        }
        
        .aqi-value {
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        /* Color classes */
        .good-level {
            color: #28a745;
        }
        .warning-level {
            color: #ffc107;
        }
        .danger-level {
            color: #dc3545;
        }
        
        /* History Section */
        .history-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        table th {
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #1e7e34;
        }
        .device-filter {
            margin-bottom: 20px;
        }
        .device-filter select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }
        
        /* Charts - Smaller and more compact */
        .chart-container {
            height: 120px;
            position: relative;
            margin-top: 10px;
            background-color: white;
            border-radius: 4px;
            padding: 8px;
            grid-column: 1 / -1;
        }
        
        /* Responsive Design */
        @media (max-width: 1400px) {
            .main-dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .main-dashboard {
                grid-template-columns: 1fr;
            }
            body {
                padding: 5px;
            }
            header {
                padding: 10px;
            }
            header h1 {
                font-size: 1.5rem;
            }
            .node-content {
                padding: 10px;
            }
            .sensor-grid {
                gap: 8px;
            }
            .sensor-item {
                padding: 8px;
            }
        }
        
        /* Ensure page fits in viewport */
        html, body {
            height: 100vh;
            overflow-x: auto;
        }
        
        .container {
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        .main-dashboard {
            flex: 1;
            align-content: start;
        }

        /* Connection status indicator */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            z-index: 1000;
        }
        .connection-online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .connection-offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="connection-status <?php echo (!empty($latestByDevice)) ? 'connection-online' : 'connection-offline'; ?>">
        <?php echo (!empty($latestByDevice)) ? '● Supabase Connected' : '● Connection Error'; ?>
    </div>

    <div class="container">
        <header>
            <h1>Dashboard Monitoring Sensor - Supabase</h1>
            <p>Monitoring CO2, H2S, dan Voltage dari Multi Node Sensor</p>
        </header>

        <!-- Main Dashboard - 4 Nodes -->
        <div class="main-dashboard">
            <?php
            if (!empty($latestByDevice)) {
                foreach ($latestByDevice as $deviceId => $nodeData) {
                    // Pastikan semua field yang dibutuhkan ada
                    $co2_ppm = isset($nodeData["co2_ppm"]) ? floatval($nodeData["co2_ppm"]) : 0;
                    $h2s_ppm = isset($nodeData["h2s_ppm"]) ? floatval($nodeData["h2s_ppm"]) : 0;
                    $voltage = isset($nodeData["voltage"]) ? floatval($nodeData["voltage"]) : 0;
                    $received_at = isset($nodeData['received_at']) ? $nodeData['received_at'] : date('Y-m-d H:i:s');
                    
                    $isOnline = (strtotime($received_at) > (time() - 300)); // Consider online if data is less than 5 minutes old
                    
                    // Determine status classes
                    $co2Class = ($co2_ppm < 1000) ? "good-level" : (($co2_ppm < 2000) ? "warning-level" : "danger-level");
                    $h2sClass = ($h2s_ppm < 10) ? "good-level" : (($h2s_ppm < 20) ? "warning-level" : "danger-level");
                    $voltageClass = ($voltage > 3.3) ? "good-level" : (($voltage > 3.0) ? "warning-level" : "danger-level");
                    
                    // Calculate node status
                    $nodeStatus = "Normal";
                    $statusClass = "good-level";
                    $alertCount = 0;
                    
                    if ($co2_ppm > 2000) {
                        $nodeStatus = "CRITICAL CO2";
                        $statusClass = "danger-level";
                        $alertCount++;
                    } elseif ($co2_ppm > 1000) {
                        $nodeStatus = "Warning CO2";
                        $statusClass = "warning-level";
                        $alertCount++;
                    }
                    
                    if ($h2s_ppm > 20) {
                        $nodeStatus = "CRITICAL H2S";
                        $statusClass = "danger-level";
                        $alertCount++;
                    } elseif ($h2s_ppm > 10) {
                        if ($statusClass != "danger-level") {
                            $nodeStatus = "Warning H2S";
                            $statusClass = "warning-level";
                        }
                        $alertCount++;
                    }
                    
                    if ($voltage < 3.0) {
                        $nodeStatus = "Low Voltage";
                        $statusClass = "danger-level";
                        $alertCount++;
                    } elseif ($voltage < 3.3) {
                        if ($statusClass == "good-level") {
                            $nodeStatus = "Voltage Warning";
                            $statusClass = "warning-level";
                        }
                        $alertCount++;
                    }
                    
                    // Calculate AQI
                    $aqi = "Good";
                    $aqiClass = "good-level";
                    $aqiValue = 0;
                    
                    if ($co2_ppm > 2000 || $h2s_ppm > 20) {
                        $aqi = "Hazardous";
                        $aqiClass = "danger-level";
                        $aqiValue = 300;
                    } elseif ($co2_ppm > 1500 || $h2s_ppm > 15) {
                        $aqi = "Unhealthy";
                        $aqiClass = "danger-level";
                        $aqiValue = 200;
                    } elseif ($co2_ppm > 1000 || $h2s_ppm > 10) {
                        $aqi = "Moderate";
                        $aqiClass = "warning-level";
                        $aqiValue = 100;
                    } else {
                        $aqiValue = 50;
                    }
                    ?>
                    
                    <div class="node-card">
                        <div class="node-header">
                            <h2>Node Sensor <?php echo htmlspecialchars($deviceId); ?></h2>
                            <div class="node-status">
                                <span><?php echo $isOnline ? 'Online' : 'Offline'; ?></span>
                                <div class="status-indicator <?php echo $isOnline ? '' : 'offline'; ?>"></div>
                            </div>
                        </div>
                        
                        <div class="node-content">
                            <div class="sensor-grid">
                                <!-- CO2 -->
                                <div class="sensor-item">
                                    <div class="sensor-label">CO2</div>
                                    <div class="sensor-value <?php echo $co2Class; ?>"><?php echo $co2_ppm; ?></div>
                                    <div class="sensor-unit">PPM</div>
                                </div>
                                
                                <!-- H2S -->
                                <div class="sensor-item">
                                    <div class="sensor-label">H2S</div>
                                    <div class="sensor-value <?php echo $h2sClass; ?>"><?php echo $h2s_ppm; ?></div>
                                    <div class="sensor-unit">PPM</div>
                                </div>
                                
                                <!-- Voltage -->
                                <div class="sensor-item">
                                    <div class="sensor-label">Voltage</div>
                                    <div class="sensor-value <?php echo $voltageClass; ?>"><?php echo number_format($voltage, 2); ?></div>
                                    <div class="sensor-unit">V</div>
                                </div>
                                
                                <!-- Status -->
                                <div class="sensor-item status-item">
                                    <div class="status-main <?php echo $statusClass; ?>"><?php echo $nodeStatus; ?></div>
                                    <div class="status-details"><?php echo $alertCount; ?> Alert(s) Active</div>
                                    
                                    <div class="aqi-info">
                                        <div class="aqi-label">Air Quality Index</div>
                                        <div class="aqi-value <?php echo $aqiClass; ?>"><?php echo $aqi; ?> (<?php echo $aqiValue; ?>)</div>
                                    </div>
                                </div>
                                
                                <!-- Mini Chart -->
                                <div class="chart-container">
                                    <canvas id="mini-chart-<?php echo htmlspecialchars($deviceId); ?>"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <?php
                }
            } else {
                echo '<div class="no-data">Tidak ada data sensor tersedia atau koneksi ke Supabase bermasalah<br>';
                if ($debug) {
                    echo 'Debug: Check browser console dan view source untuk debug info';
                }
                echo '</div>';
            }
            ?>
        </div>

        <!-- History Section -->
        <div class="history-section" id="history-section">
            <div class="history-header">
                <h2>Riwayat Data Semua Node</h2>
                <div>
                    <div class="device-filter">
                        <select id="device-filter">
                            <option value="">Semua Device</option>
                            <?php
                            foreach ($uniqueDevices as $deviceId) {
                                echo '<option value="'.$deviceId.'">Node '.$deviceId.'</option>';
                            }
                            ?>
                        </select>
                        <button class="btn btn-success" id="filter-btn">Filter</button>
                    </div>
                    <button class="btn" id="export-btn">Export Data</button>
                </div>
            </div>
            
            <table id="history-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Node ID</th>
                        <th>CO2 (PPM)</th>
                        <th>H2S (PPM)</th>
                        <th>Voltage (V)</th>
                        <th>Sensor Info</th>
                        <th>Waktu</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                    if ($historyData && !empty($historyData) && is_array($historyData)) {
                        foreach($historyData as $row) {
                            $id = isset($row["id"]) ? $row["id"] : 'N/A';
                            $device_id = isset($row["device_id"]) ? $row["device_id"] : 'N/A';
                            $co2_ppm = isset($row["co2_ppm"]) ? $row["co2_ppm"] : 0;
                            $h2s_ppm = isset($row["h2s_ppm"]) ? $row["h2s_ppm"] : 0;
                            $voltage = isset($row["voltage"]) ? number_format($row["voltage"], 2) : '0.00';
                            $sensors = isset($row["sensors"]) ? htmlspecialchars($row["sensors"]) : '';
                            $received_at = isset($row["received_at"]) ? date('Y-m-d H:i:s', strtotime($row["received_at"])) : 'N/A';
                            
                            echo "<tr data-device='".$device_id."'>
                                    <td>".$id."</td>
                                    <td>Node ".$device_id."</td>
                                    <td>".$co2_ppm."</td>
                                    <td>".$h2s_ppm."</td>
                                    <td>".$voltage."</td>
                                    <td>".$sensors."</td>
                                    <td>".$received_at."</td>
                                </tr>";
                        }
                    } else {
                        echo "<tr><td colspan='7' class='no-data'>Tidak ada data tersedia";
                        if ($debug) {
                            echo " (Debug: historyData is " . (is_array($historyData) ? 'array with ' . count($historyData) . ' items' : gettype($historyData)) . ")";
                        }
                        echo "</td></tr>";
                    }
                    ?>
                </tbody>
            </table>
        </div>
    </div>

<script>
// Initialize mini charts for each device
function initMiniCharts() {
    console.log('Initializing mini charts...');
    
    <?php
    if (!empty($latestByDevice)) {
        foreach ($latestByDevice as $deviceId => $nodeData) {
            // Get 12-hour historical data for this specific device from Supabase
            $twelveHoursAgo = date('c', strtotime('-12 hours')); // ISO 8601 format
            $chartEndpoint = "sensor_data_complete?device_id=eq.$deviceId&received_at=gte.$twelveHoursAgo&order=received_at.asc&limit=100";
            $chartData = supabaseQuery($chartEndpoint);
            
            $labels = [];
            $co2Data = [];
            $h2sData = [];
            $voltageData = [];
            
            if ($chartData && !empty($chartData) && is_array($chartData)) {
                foreach($chartData as $row) {
                    $timestamp = strtotime($row["received_at"]);
                    $labels[] = date('H:i', $timestamp);
                    $co2Data[] = isset($row["co2_ppm"]) ? floatval($row["co2_ppm"]) : 0;
                    $h2sData[] = isset($row["h2s_ppm"]) ? floatval($row["h2s_ppm"]) : 0;
                    $voltageData[] = isset($row["voltage"]) ? floatval($row["voltage"]) : 0;
                }
            }
            
            // If no data, create default
            if (empty($labels)) {
                $labels = ['No Data'];
                $co2Data = [0];
                $h2sData = [0];
                $voltageData = [0];
            }
            
            // Escape device ID for JavaScript
            $jsDeviceId = json_encode($deviceId);
            ?>
            
            // Mini Chart for device <?php echo htmlspecialchars($deviceId); ?>
            try {
                const miniCanvas<?php echo preg_replace('/[^a-zA-Z0-9]/', '', $deviceId); ?> = document.getElementById('mini-chart-' + <?php echo $jsDeviceId; ?>);
                if (miniCanvas<?php echo preg_replace('/[^a-zA-Z0-9]/', '', $deviceId); ?>) {
                    new Chart(miniCanvas<?php echo preg_replace('/[^a-zA-Z0-9]/', '', $deviceId); ?>.getContext('2d'), {]);
                    $h2sData[] = floatval($row["h2s_ppm"]);
                    $voltageData[] = floatval($row["voltage"]);
                }
            }
            
            // If no data, create default
            if (empty($labels)) {
                $labels = ['No Data'];
                $co2Data = [0];
                $h2sData = [0];
                $voltageData = [0];
            }
            ?>
            
            // Mini Chart for device <?php echo $deviceId; ?>
            try {
                const miniCanvas<?php echo $deviceId; ?> = document.getElementById('mini-chart-<?php echo $deviceId; ?>');
                if (miniCanvas<?php echo $deviceId; ?>) {
                    new Chart(miniCanvas<?php echo $deviceId; ?>.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: <?php echo json_encode($labels); ?>,
                            datasets: [
                                {
                                    label: 'CO2',
                                    data: <?php echo json_encode($co2Data); ?>,
                                    borderColor: '#007bff',
                                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                    tension: 0.1,
                                    borderWidth: 1,
                                    pointRadius: 1
                                },
                                {
                                    label: 'H2S',
                                    data: <?php echo json_encode($h2sData); ?>,
                                    borderColor: '#28a745',
                                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                    tension: 0.1,
                                    borderWidth: 1,
                                    pointRadius: 1
                                },
                                {
                                    label: 'Voltage',
                                    data: <?php echo json_encode($voltageData); ?>,
                                    borderColor: '#ffc107',
                                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                    tension: 0.1,
                                    borderWidth: 1,
                                    pointRadius: 1,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        pointStyle: 'line',
                                        font: { size: 10 }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    display: false
                                },
                                y: {
                                    display: false,
                                    beginAtZero: true,
                                    position: 'left'
                                },
                                y1: {
                                    display: false,
                                    beginAtZero: true,
                                    position: 'right'
                                }
                            },
                            elements: {
                                point: {
                                    radius: 0
                                }
                            }
                        }
                    });
                }
                console.log('Chart initialized for device <?php echo $deviceId; ?>');
            } catch (error) {
                console.error('Error initializing chart for device <?php echo $deviceId; ?>:', error);
            }
            
            <?php
        }
    } else {
        echo "console.log('No sensor data available for mini charts');";
    }
    ?>
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    const filterBtn = document.getElementById('filter-btn');
    const exportBtn = document.getElementById('export-btn');
    
    // Filter function
    if (filterBtn) {
        filterBtn.addEventListener('click', function() {
            const selectedDevice = document.getElementById('device-filter').value;
            const tableRows = document.querySelectorAll('#history-table tbody tr');
            
            tableRows.forEach(row => {
                if (selectedDevice === '' || row.dataset.device === selectedDevice) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // Export function
    if (exportBtn) {
        exportBtn.addEventListener('click', function() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Node ID,CO2 (PPM),H2S (PPM),Voltage (V),Sensor Info,Waktu\n";
            
            const table = document.getElementById('history-table');
            if (table) {
                const visibleRows = Array.from(table.rows).filter(row => row.style.display !== 'none');
                
                for (let i = 1; i < visibleRows.length; i++) {
                    const row = visibleRows[i];
                    const rowData = [];
                    for (let j = 0; j < row.cells.length; j++) {
                        rowData.push('"' + row.cells[j].textContent.replace(/"/g, '""') + '"');
                    }
                    csvContent += rowData.join(",") + "\n";
                }
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `supabase_sensor_data_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });
    }

    // Initialize mini charts and check alerts
    initMiniCharts();
    checkCriticalAlerts();
    
    // Clear alert session after 5 minutes
    setTimeout(() => {
        if (typeof(Storage) !== "undefined") {
            sessionStorage.removeItem('alertShown');
        }
    }, 300000);
});

// Alert monitoring and notifications
function checkCriticalAlerts() {
    <?php if (!empty($latestByDevice)): ?>
    const criticalNodes = [];
    <?php foreach ($latestByDevice as $deviceId => $nodeData): ?>
        <?php if ($nodeData["co2_ppm"] > 2000 || $nodeData["h2s_ppm"] > 20 || $nodeData["voltage"] < 3.0): ?>
            criticalNodes.push({
                nodeId: '<?php echo $deviceId; ?>',
                co2: <?php echo $nodeData["co2_ppm"]; ?>,
                h2s: <?php echo $nodeData["h2s_ppm"]; ?>,
                voltage: <?php echo $nodeData["voltage"]; ?>
            });
        <?php endif; ?>
    <?php endforeach; ?>
    
    if (criticalNodes.length > 0) {
        let alertMessage = "⚠️ CRITICAL ALERTS DETECTED:\n\n";
        criticalNodes.forEach(node => {
            alertMessage += `Node ${node.nodeId}:\n`;
            if (node.co2 > 2000) alertMessage += `• CO2: ${node.co2} PPM (CRITICAL)\n`;
            if (node.h2s > 20) alertMessage += `• H2S: ${node.h2s} PPM (CRITICAL)\n`;
            if (node.voltage < 3.0) alertMessage += `• Voltage: ${node.voltage}V (LOW)\n`;
            alertMessage += "\n";
        });
        
        // Show alert only once per session
        if (typeof(Storage) !== "undefined" && !sessionStorage.getItem('alertShown')) {
            alert(alertMessage);
            sessionStorage.setItem('alertShown', 'true');
        }
        
        // Change page title to indicate alert
        document.title = `⚠️ ${criticalNodes.length} ALERTS - Supabase Sensor Monitor`;
    }
    <?php else: ?>
    console.log('No sensor data available for alert checking');
    <?php endif; ?>
}

// Auto refresh every 30 seconds
setInterval(function() {
    location.reload();
}, 30000);

// Connection status check
function checkConnection() {
    fetch(window.location.href)
        .then(response => {
            const statusEl = document.querySelector('.connection-status');
            if (response.ok) {
                statusEl.className = 'connection-status connection-online';
                statusEl.textContent = '● Supabase Connected';
            } else {
                statusEl.className = 'connection-status connection-offline';
                statusEl.textContent = '● Connection Error';
            }
        })
        .catch(() => {
            const statusEl = document.querySelector('.connection-status');
            statusEl.className = 'connection-status connection-offline';
            statusEl.textContent = '● Connection Error';
        });
}

// Check connection every 10 seconds
setInterval(checkConnection, 10000);
</script>
</body>
</html>
